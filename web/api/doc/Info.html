<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<head>
    <title>Создание тасков</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <style>
    body {
        font: 80% Verdana, Tahoma, Arial, sans-serif;
    }

    h1,
    h2,
    h3,
    h4 {
        font-family: "Trebuchet MS", Georgia, "Times New Roman", serif;
    }

    ul.toc {
        padding: 4px;
        margin-left: 0;
    }

    ul.toc li {
        list-style-type: none;
    }

    ul.toc li.heading2 {
        margin-left: 1em;
    }

    ul.toc li.heading3 {
        margin-left: 2em;
    }

    a.wiki-anchor {
        display: none;
        margin-left: 6px;
        text-decoration: none;
    }

    a.wiki-anchor:hover {
        color: #aaa !important;
        text-decoration: none;
    }

    h1:hover a.wiki-anchor,
    h2:hover a.wiki-anchor,
    h3:hover a.wiki-anchor {
        display: inline;
        color: #ddd;
    }
    </style>
</head>

<body>
    <ul class="toc">
        <li>1 <a href="#Обновление-тасков">Обновление тасков</a></li>
        <li>2 <a href="#Этапы-обновления-тасков">Этапы обновления тасков</a></li>
        <li>3 <a href="#Повторное-обновление-тасков-ручной-запуск">Повторное обновление тасков (ручной запуск)</a></li>
        <li>4 <a href="#Таже-учесть">Таже учесть</a></li>
        <li>5 <a href="#Таблица-тасков">Таблица тасков</a></li>
        <li>6 <a href="#Ручное-обновление-заданий">Ручное обновление заданий</a></li>
        <li>7 <a href="#Логирование ответов worker">Логирование ответов worker</a></li>
        <li>8 <a href="#Фильтры">Фильтры</a></li>
        <li>9 <a href="#Паузы-стратегий">Паузы стратегий</a></li>
    </ul>
    <a name="Таски"></a>
    <h1>1 Обновление тасков<a href="#Обновление-тасков" class="wiki-anchor">&para;</a></h1>
    <ul>
        <li><strong>Кейс / дело</strong> - дело отобранное по фильтру сегментирования.</li>
        <li><strong>Таск / задание</strong> - задание на уведомление дела.</li>
        <li><strong>Рабочий график</strong> - график рабочих дней. Два статуса: рабочий (пн..пт) / выходной (сб..вс+праздники). График корректируется только для будущих дат.</li>
        <li><strong>Создание тасков</strong> - создание тасков на agent.</li>
        <li><strong>Отправка тасков</strong> - отправка тасков на worker.</li>
        <li><strong>Обновление / refresh</strong> - создание на агенте и отправка воркеру свежих тасков.</li>
        <li><strong>Ключ уникальности таска</strong> - составной ключ уникальности, который учитывается при ежедневном создании тасков, не зависимо от типа стратегии (ручная или основная).
            <br />Ключ уникальности состоит из полей:
            <br />- <em>case_id</em> - ид. дела,
            <br />- <em>task_type_id</em> - ид. инструмента,
            <br />- <em>contragent_id</em> - ид. контрагента,
            <br />- <em>strategy_id</em> - ид. стратегии,
            <br />- <em>strategy_item_id</em> - ид. тактики,
            <br />- <em>todo_at</em> - дата создания таска на agent.</li>
    </ul>
    <a name="Этапы-обновления-тасков"></a>
    <h1>2 Этапы обновления тасков<a href="#Этапы-обновления-тасков" class="wiki-anchor">&para;</a></h2>
    <p><strong>Создание тасков на агенте - ежедневно.</strong></p>
    <ul>
        <li>При удачном создании таска, полю <em>todo_at</em> присваивается текущая дата.</li>
        <li>При создании таска, учитывается <em>составной ключ уникальности</em>.</li>
    </ul>
    <p><strong>Отправка тасков воркеру - ежедневно.</strong></p>
    <ul>
        <li>Если для инструмента включена опция <em>is_working_only</em> (фичя на уточнении), то по выходным дням отправка тасков воркеру откладывается на ближайший рабочий день.</li>
        <li>При добавлении таска на отправку воркеру, полю <em>todo_last</em> присваивается запланированная дата отправки.</li>
    </ul>
    <p><strong>Получение тасков воркером.</strong></p>
    <ul>
        <li>Если воркер получил таск, полю <em>todo_taken</em> присваивается дата удачного получения таска воркером.</li>
    </ul>
    <a name="Повторное-обновление-тасков-ручной-запуск"></a>
    <h1>3 Повторное обновление тасков <em>(ручной запуск)</em><a href="#Повторное-обновление-тасков-ручной-запуск" class="wiki-anchor">&para;</a></h1>
    <ul>
        <li>1. Исключено дублироване тасков. Исходя из ключа уникальности, будут созданы только новые таски.</li>
        <li>2. Исключается повторная отправка тасков. Будут отправлены только те таски, для которых не заполнено поле <em>todo_taken</em>.</li>
    </ul>
    <h3>Время ожидания ответа от воркера 120 секунд.</h3>
    <h3>Не в полной мере описана задача, котрую должны выполнять исключения.Соответственно и пересечения.    </h3>
    <a name="Таже-учесть"></a>
    <h1>4 Таже учесть<a href="#Таже-учесть" class="wiki-anchor">&para;</a></h1>
    <a name="На-агенте"></a>
    <h3>На агенте<a href="#На-агенте" class="wiki-anchor">&para;</a></h3>
    <ul>
        <li>Не предусмотрена отмена таска на агенте.</li>
        <li>Не предусмотрена отмена отправки таска воркеру.</li>
    </ul>
    <a name="На-воркере"></a>
    <h3>На воркере<a href="#На-воркере" class="wiki-anchor">&para;</a></h3>
    <ol>
        <li>Передача даты выполнения воркеру. Например, для создания таск на полендельник в воскресенье.</li>
        <li>Пакетная отправка/отмена тасков. (csv, xml, json etc.). Описание формата ответа и запроса.</li>
        <li>Передача <em>task_id</em> воркеру.</li>
    </ol>
    <strong>Профит:</strong>
    <ol>
        <li>Целостность данных между воркером и агентом. Возможно будет получить полную информацию по таску используя его task_id (тактика, стратегия и т.п. ) .</li>
        <li>Отмена таска по <em>task_id</em>. Сейчас отмены нету. Если отмена будет, логично делать по task_id.</li>
        <li>Если будет необходимо обновить таски за день. В ручном режиме, скажем, после изменения настроек тактики. По результатам новых настроек, некоторые таски станут не актуальны (допустим нужно отменить 10 тасков из 900000). Каким образом их отменить сначала на агенте, а потом на воркере? Для этого стоит использовать task_id.</li>
    </ol>
    <p><strong>К обсуждению:</strong></p>
    <ol>
        <li>Помимо case_id, воркеру передаётся и task_id</li>
        <li>Помимо case_id, воркеру передаётся и todo_last - дата, на которую создан таск.</li>
        <li>Предусмотреть возможность отмены таска на worker по его task_id.</li>
        <li>Почему-то не всегда отдаётся ответ от воркера. Возможно это из за того, что у нас фильтры настроены "от фонаря" и при настройке правильных фильтров будут все запросы 200 OK.</li>
    </ol>
    <a name="Таблица-тасков"></a>
    <h1>5 Таблица тасков<a href="#Таблица-тасков" class="wiki-anchor">&para;</a></h1>
    <p><img src="/attachments/download/329/picture884-1.png" alt="" /></p>
    <table>
        <tr>
            <td> <strong>поле</strong> </td>
            <td> <strong>описание</strong> </td>
        </tr>
        <tr>
            <td> id </td>
            <td> идентификатор task_id </td>
        </tr>
        <tr>
            <td> strategy_id </td>
            <td> стратегия </td>
        </tr>
        <tr>
            <td> strategy_item_id </td>
            <td> активность </td>
        </tr>
        <tr>
            <td> task_type_id </td>
            <td> инструмент </td>
        </tr>
        <tr>
            <td> case_id </td>
            <td> дело </td>
        </tr>
        <tr>
            <td> contragent_id </td>
            <td> контрагент </td>
        </tr>
        <tr>
            <td> dps_name </td>
            <td> сегмент </td>
        </tr>
        <tr>
            <td> priority </td>
            <td> приоритет выполнения </td>
        </tr>
        <tr>
            <td> todo_at </td>
            <td> дата создания задания на агенте </td>
        </tr>
        <tr>
            <td> todo_last </td>
            <td> дата, на которую запланирована отправки задания на воркер </td>
        </tr>
        <tr>
            <td> todo_taken </td>
            <td> дата успешной отправки задания на воркер </td>
        </tr>
    </table>
    <a name="Ручное-обновление-заданий"></a>
    <h1>6 Ручное обновление заданий<a href="#Ручное-обновление-заданий" class="wiki-anchor">&para;</a></h1>
    <h3>Время ожидания ответа от воркера 120 секунд.</h3>
    <p><strong>Запуск:</strong>
        <br /><em>curl -XGET <a class="external" href="https://sb.ssh.in.ua/agent/run">https://sb.ssh.in.ua/agent/run</a></em></p>
    <p>Ответы:
        <br /><em>START    - обновление запущено успешно.</em>
        <br /><em>PROGRESS - обновление не запущено, т. к. сейчас уже выполняется обновление.</em></p>
    <p><strong>Статус:</strong>
        <br /><em>curl -XGET <a class="external" href="https://sb.ssh.in.ua/agent/status">https://sb.ssh.in.ua/agent/status</a></em></p>
    <p>Ответы:
        <br /><em>0 - нет запущеных обновлений.</em>
        <br /><em>1 - обновление запущено.</em></p>
    <p><strong>Остановка:</strong>
        <br /><em>curl -XGET <a class="external" href="https://sb.ssh.in.ua/agent/kill">https://sb.ssh.in.ua/agent/kill</a></em></p>
    <p>Ответы:
        <br /><em>0 - нет запущеных обновлений</em></p>
    <p><strong>Очистка прогнозов:</strong>
        <br /><em>curl -XGET <a class="external" href="https://sb.ssh.in.ua/agent/clearfc">https://sb.ssh.in.ua/agent/clearfc</a></em></p>
    <p><strong>Очистка тасков за сегодня:</strong>
        <br /><em>curl -XGET <a class="external" href="https://sb.ssh.in.ua/agent/clear">https://sb.ssh.in.ua/agent/clear</a></em></p>
    <p><strong>Отправка тасков за сегодня на воркер:</strong>
        <br/><em>curl -XGET <a class="external" href="https://sb.ssh.in.ua/agent/runtusk">https://sb.ssh.in.ua/agent/runtusk</a></em></p>
    <p><strong>Доступны логи выполнения run и runtask:</strong>
        <br/><em>https://sb.ssh.in.ua/ws</em></p>
    <a name="Логирование ответов worker"></a>
    <h1>7 Логирование ответов worker</h1>
    <h2>Описание ключа</h2>
    Ответы от worker-а хранятся в Redis. <br><br>
    <b>Для тактики хранится последный ответ от workera для теущего дня</b> .
    <br>
    <br> Допустим для даты 2018-03-13, инструмента 5, стратегии 50, активности 102 ключ будет следующего вида:
    <br>
    <br>
    <em>"log:strategy-case:2018-03-13:5:50:102"</em>
    <br>
    <br> Описание ключа
    <br>
    <br>
    <em>лог : worker url    :  дата        : task_type  : strategy_id :  strategy_item_id</em>
    <br>
    <h2>REST</h2>
    <b>Получение всех ключей*</b>
    <br>
    <em>curl -XGET https://sb.ssh.in.ua/redis</em>
    <br>
    <br>
    <b>Получение всех ключей содержащих "*log*"</b>
    <br>
    <em>curl -XGET https://sb.ssh.in.ua/redis/*log*</em>
    <br>
    <br>
    <b>Получение значения из хранилища по ключу</b> <em>log:strategy-case:2018-03-13:5:26:15</em>
    <br>
    <em>curl -XGET https://sb.ssh.in.ua/redisval/log:strategy-case:2018-03-13:5:26:15</em>
    <br>
    <a name="Фильтры"></a>
    <h1>8 Фильтры<a href="#Фильтры" class="wiki-anchor">&para;</a></h1>
    <a name="Типы-фильтров"></a>
    <h2>Типы фильтров<a href="#Типы-фильтров" class="wiki-anchor">&para;</a></h2>
    <table>
        <tr>
            <td> <strong>Фильтры набора характеристик</strong> </td>
            <td> фильтры, которые привязаны к определенному набору характеристик. </td>
        </tr>
        <tr>
            <td> <strong>Фильтры стратегии</strong> </td>
            <td> фильтры, которые привязаны к определенной стратегии. </td>
        </tr>
        <tr>
            <td> <strong>Фильтры тактики</strong> </td>
            <td> фильтры, которые привязаны к определенной тактике плюс фильтры стратегии этой тактики. </td>
        </tr>
        <tr>
            <td> <strong>Фильтры активные</strong> </td>
            <td> фильтры с флагом is_public = true. </td>
        </tr>
        <tr>
            <td> <strong>Фильтры OR</strong> </td>
            <td> фильтры с флагом is_or = true. </td>
        </tr>
        <tr>
            <td> <strong>Фильтры AND</strong> </td>
            <td> фильтры с флагом is_or = false. </td>
        </tr>
        <tr>
            <td> <strong>Фильтры BETWEEN</strong> </td>
            <td> диапазон указывается через "?". Пример: <em>beetween:"5?7"</em>. </td>
        </tr>
        <tr>
            <td> <strong>Фильтры IN</strong> </td>
            <td> список указывается через ",". Пример: <em>= "1,2,3,4,5"</em>. </td>
        </tr>
        <tr>
            <td> <strong>Фильтры NOT IN</strong> </td>
            <td> диапазон указывается через ",". Пример: <em>!= "3,4,1,5,8"</em>. </td>
        </tr>
        <tr>
            <td> <strong>Фильтры сегментные</strong> </td>
            <td> фильтры с флагом is_segment = true, для котороых автоматически определяется дата, исходя из значения фильтра. </td>
        </tr>
    </table>
    <p>Пример: сегодня 2018-01-19, значение 5 будет определено, как текущая 2018-01-19 + 5 дней, а именно 2018-01-24.
        <br />Допускаются отрицательные значений. Сегментные фильтры добавляются только к тактике. |</p>
    <a name="Паузы-стратегий"></a>
    <h1>9 Паузы стратегий<a href="#Паузы-стратегий" class="wiki-anchor">&para;</a></h1>
    <p><strong>Статус стратегии</strong> - статус обозначающий рабочее состояние стратегии. Может быть два статуса (<strong>вкл.</strong> / <strong>выкл.</strong>)
        <br /><strong>Статус периода</strong> - статус обозначающий необходимое рабочее состояние стратегии на период действия паузы. Может быть два варианта (<strong>вкл.</strong> / <strong>выкл.</strong>)
        <br /><strong>Статус после периода</strong>- по истечению действия паузы, для стратегии устанавливается статус противоположный <strong>статусу периода</strong>
        <br /><strong>Дата с</strong> - дата активации паузы. Может быть датой 2018-03-01. Не должна быть меньше текущей даты и больше или равной дате де активации.
        <br /><strong>Дата по</strong> - дата де активации паузы. Может быть датой 2018-03-02. Не должна быть меньше равна текущей дате и дате активации.
        <br /><strong>Комментарий</strong> - описание назначения паузы.</p>
    <a name="Описание-работы"></a>
    <h2>Описание пауз<a href="#Описание-работы" class="wiki-anchor">&para;</a></h2>
    <p>Во время действия паузы, для стратегии присваивается состояние соответствующее <em>статусу периода (set_is_public_to)</em>.
        <br />По истечению периода действия паузы (на следующий календарный день), для стратегии устанавливается статус противоположный <em>статусу периода (set_is_public_to)</em>.
        <br />Для паузы текущего дня автоматически изменяется статус стратегии.
        <br />При удалении паузы, статус стратегии не изменяется.
        <br />Пауз может быть создано любое количество.
        <br />История пауз сохраняется.</p>
</body>

</html>